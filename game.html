<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Order Failure Training Arcade (Web)</title>
  <style>
    body {
      background: #000;
      color: #00ff66;
      font-family: "Courier New", monospace;
      margin: 0;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    #screen {
      border: 2px solid #00ff66;
      padding: 16px 20px;
      max-width: 900px;
      width: 95%;
      height: 85vh;
      box-shadow: 0 0 10px #00ff66;
      display: flex;
      flex-direction: column;
    }
    #header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 1px;
      font-size: 13px;
    }
    #titleBar {
      font-weight: bold;
    }
    #timer {
      text-align: right;
    }
    #content {
      flex: 1;
      overflow-y: auto;
      margin-top: 4px;
      padding-top: 4px;
      border-top: 1px solid #004400;
      white-space: pre-wrap;
    }
    #options {
      margin-top: 8px;
    }
    button {
      background: #001100;
      color: #00ff66;
      border: 1px solid #00ff66;
      padding: 4px 10px;
      margin: 2px 4px 2px 0;
      font-family: inherit;
      font-size: 13px;
      cursor: pointer;
    }
    button:hover {
      background: #003300;
    }
  </style>
</head>
<body>
  <div id="screen">
    <div id="header">
      <div id="titleBar">ORDER FAILURE TRAINING ARCADE (WEB)</div>
      <div id="timer">TIME: -- | CREDITS: -- | HINTS: 3</div>
    </div>
    <div id="content"></div>
    <div id="options"></div>
  </div>

  <script>
    // ---------- BASIC UI WIRING ----------

    const screenEl = document.getElementById("content");
    const optionsEl = document.getElementById("options");
    const timerEl = document.getElementById("timer");

    let credits = 3;
    let timeLeft = 120; // seconds
    let timerId = null;
    let currentScenarioId = null;

    // Hints
    let hintsLeft = 3;
    let currentHintContext = null;

    // Bonus mini-game state
    let miniGameActive = false;
    let miniGameState = null;
    let miniGameLoopId = null;

    // Game state per scenario
    const gameState = {
      1: { hasEidFromBoarding: false },
      2: { hasSupplierShipToFromList: false, selectedSupplierShipTo: null },
      3: {
        hasSupplierShipToFromCustomer: false,
        capturedSupplierShipTo: null,
        savedToSupplierDefined: false
      }
    };

    // Scenario definitions
    const scenarios = {
      1: {
        id: 1,
        name: "Scenario 1 - Powergate pharmacy (ShipTo -> EID)",
        poRef: "T234565",
        orderDateTime: "2025/11/28 15:43",
        errorText: "CustomerSpecificShipTo {1234} to EID (null) missing.",
        senderName: "HealthPlus Pharmacy",
        supplierName: "Prosthetics UK",
        descriptionLines: [
          "A pharmacy order has failed with a missing mapping",
          "from a CustomerSpecificShipTo to an EID.",
          "",
          "You need to work out where to find the correct identifier",
          "and how to map it before the timer runs out."
        ],
        correctEid: "123456789",
        // Order details addresses (no IDs shown here)
        buyerAddress: {
          name: "HealthPlus Pharmacy",
          department: "Pharmacy Office",
          street: "42 High Street",
          city: "London",
          postcode: "NW3 5AB",
          country: "UK"
        },
        shipToAddress: {
          department: "Main Stores",
          street: "7 Warehouse Lane",
          city: "London",
          postcode: "NW3 5AB",
          country: "UK"
        },
        billToAddress: {
          department: "Accounts",
          street: "1 Finance Road",
          city: "London",
          postcode: "NW1 2CD",
          country: "UK"
        }
      },
      2: {
        id: 2,
        name: "Scenario 2 - SupplierDefined Accounts (ShipTo -> SupplierSpecific)",
        poRef: "PO567890",
        orderDateTime: "2025/11/28 10:12",
        errorText: "CustomerSpecificShipTo {5678} to SupplierSpecificShipTo (null) missing.",
        senderName: "Riverside Pharmacy",
        supplierName: "PharmaSupply Ltd",
        descriptionLines: [
          "A pharmacy order has failed because a CustomerSpecificShipTo",
          "doesn't have a SupplierSpecificShipTo mapping.",
          "",
          "There are several potential places where this information",
          "could live. Choose wisely."
        ],
        correctCustomerShipTo: "5678",
        correctSupplierShipTo: "PG-SHIP-5678",
        buyerAddress: {
          name: "Riverside Pharmacy",
          department: "Front Counter",
          street: "15 Riverside Walk",
          city: "Leeds",
          postcode: "LS1 4AA",
          country: "UK"
        },
        shipToAddress: {
          department: "Back Room",
          street: "22 Stock Lane",
          city: "Leeds",
          postcode: "LS1 4AB",
          country: "UK"
        },
        billToAddress: {
          department: "Accounts",
          street: "10 Finance Crescent",
          city: "Leeds",
          postcode: "LS2 3CD",
          country: "UK"
        }
      },
      3: {
        id: 3,
        name: "Scenario 3 - NHS Supply Chain (missing SupplierSpecific)",
        poRef: "NSC123456",
        orderDateTime: "2025/11/29 09:30",
        errorText: "CustomerSpecificShipTo {2468} to SupplierSpecificShipTo (null) missing.",
        senderName: "Eastside NHS Trust",
        supplierName: "NHS Supply Chain",
        descriptionLines: [
          "An NHS order fails because the CustomerSpecificShipTo has",
          "no SupplierSpecificShipTo mapping.",
          "",
          "The usual internal list doesn't contain an entry for this",
          "ship-to. You need to decide how to get and store a new account."
        ],
        correctCustomerShipTo: "2468",
        correctSupplierShipTo: "Q34M35",
        buyerAddress: {
          name: "Eastside NHS Trust",
          department: "Procurement",
          street: "100 Hospital Road",
          city: "Birmingham",
          postcode: "B2 4ZZ",
          country: "UK"
        },
        shipToAddress: {
          department: "Main Stores",
          street: "2 Delivery Yard",
          city: "Birmingham",
          postcode: "B2 4ZZ",
          country: "UK"
        },
        billToAddress: {
          department: "Finance",
          street: "5 Ledger Street",
          city: "Birmingham",
          postcode: "B2 3QQ",
          country: "UK"
        }
      }
    };

    function getScenario() {
      return scenarios[currentScenarioId];
    }

    // ---------- TIMER & CREDITS & HINTS ----------

    function updateStatusBar() {
      if (miniGameActive) return; // mini-game overrides the bar
      const t = timerId ? `${timeLeft}s` : "--";
      timerEl.textContent = `TIME: ${t} | CREDITS: ${credits} | HINTS: ${hintsLeft}`;
    }

    function startTimer() {
      if (timerId) clearInterval(timerId);
      timeLeft = 120;
      updateStatusBar();
      timerId = setInterval(() => {
        timeLeft--;
        if (timeLeft <= 0) {
          timeLeft = 0;
          clearInterval(timerId);
          timerId = null;
          updateStatusBar();
          showTimeUp();
        } else {
          updateStatusBar();
        }
      }, 1000);
    }

    function resetCredits() {
      credits = 3;
      updateStatusBar();
    }

    function loseCredit() {
      credits--;
      if (credits <= 0) {
        credits = 0;
        if (timerId) {
          clearInterval(timerId);
          timerId = null;
        }
        updateStatusBar();
        showGameOver();
      } else {
        updateStatusBar();
      }
    }

    // ---------- HINTS ----------

    function useHint(context) {
      if (miniGameActive) return;
      if (hintsLeft <= 0) {
        alert("No hints left for this run.");
        return;
      }
      const sc = getScenario();
      if (!sc) {
        alert("Hints are only available during scenarios.");
        return;
      }
      hintsLeft--;
      updateStatusBar();

      let hint = "Think about your next logical step based on what you see.";

      if (sc.id === 1) {
        if (context === "error") {
          hint = "Where would you normally find internal identifiers linked to a ship-to and address for this provider?";
        } else if (context === "boarding") {
          hint = "Try matching the address or GLN on the order to a row, then look at the identifier on that row.";
        } else if (context === "checkFurther") {
          hint = "If an EID mapping is missing, what internal data should you create it from?";
        } else if (context === "process") {
          hint = "Your mapping should use ShipTo, CustomerSpecificShipTo on the FROM side, and an EID on the TO side.";
        } else if (context === "details") {
          hint = "Compare the order addresses with whatever internal lists you have before deciding the identifier.";
        }
      } else if (sc.id === 2) {
        if (context === "error") {
          hint = "For supplier-specific codes, is the first place you check a boarding sheet or a dedicated account list?";
        } else if (context === "checkFurther") {
          hint = "Look for a list that pairs Customer ShipTo IDs with the Supplier's ShipTo IDs.";
        } else if (context === "process") {
          hint = "Your TO side should reference a SupplierSpecificShipTo value you've verified in the correct list.";
        } else if (context === "details") {
          hint = "Make sure the ShipTo ID you use matches the one shown on the failing order.";
        }
      } else if (sc.id === 3) {
        if (context === "error") {
          hint = "If an internal list has no entry, what is your next escalation route before guessing an identifier?";
        } else if (context === "checkFurther") {
          hint = "No line for this ShipTo means you probably need a brand-new account from somewhere.";
        } else if (context === "contact") {
          hint = "Pay attention to the exact string the customer gives you and think about where you store it.";
        } else if (context === "process") {
          hint = "A future-proof fix means your mapping uses the new account AND the internal list is updated.";
        } else if (context === "details") {
          hint = "The order details tell you which ship-to you are fixing. Use that consistently across your steps.";
        }
      }

      alert("Hint: " + hint);
    }

    // ---------- SCREEN RENDERING ----------

    function setScreen(textLines, buttons, hintContext = null) {
      screenEl.textContent = "";
      optionsEl.textContent = "";

      const txt = Array.isArray(textLines) ? textLines.join("\n") : textLines;
      screenEl.textContent = txt;

      currentHintContext = hintContext;

      // Render main buttons
      buttons.forEach(btn => {
        const b = document.createElement("button");
        b.textContent = btn.label;
        b.onclick = btn.onClick;
        optionsEl.appendChild(b);
      });

      // Add Hint button automatically on scenario screens if hints remain
      if (currentScenarioId !== null && hintsLeft > 0 && hintContext) {
        const hb = document.createElement("button");
        hb.textContent = `Hint (${hintsLeft} left)`;
        hb.onclick = () => useHint(hintContext);
        optionsEl.appendChild(hb);
      }
    }

    // ---------- MAIN MENU ----------

    function showMainMenu() {
      if (timerId) {
        clearInterval(timerId);
        timerId = null;
      }
      currentScenarioId = null;
      stopMiniGame();
      updateStatusBar();

      const lines = [
        "WELCOME TO THE ORDER FAILURE TRAINING ARCADE (WEB)",
        "",
        "Choose a scenario to train:",
        "",
        "  1) Scenario 1 - Powergate pharmacy (ShipTo -> EID)",
        "  2) Scenario 2 - SupplierDefined Accounts (ShipTo -> SupplierSpecific)",
        "  3) Scenario 3 - NHS Supply Chain (missing SupplierSpecific)",
        "",
        "You have:",
        "  - 2 minutes per scenario",
        "  - 3 credits per run",
        "  - 3 hints total (for all scenarios)",
        "",
        "Try to complete the scenarios with as few hints as possible."
      ];

      setScreen(lines, [
        { label: "Play Scenario 1", onClick: () => beginScenario(1) },
        { label: "Play Scenario 2", onClick: () => beginScenario(2) },
        { label: "Play Scenario 3", onClick: () => beginScenario(3) }
      ]);
    }

    function beginScenario(id) {
      currentScenarioId = id;
      // reset state for that scenario
      if (id === 1) gameState[1] = { hasEidFromBoarding: false };
      if (id === 2) gameState[2] = { hasSupplierShipToFromList: false, selectedSupplierShipTo: null };
      if (id === 3) gameState[3] = {
        hasSupplierShipToFromCustomer: false,
        capturedSupplierShipTo: null,
        savedToSupplierDefined: false
      };

      resetCredits();
      startTimer();
      showScenarioIntro();
    }

    function showScenarioIntro() {
      const sc = getScenario();
      const lines = [
        sc.name,
        "",
        `PO:        ${sc.poRef}`,
        `Date/Time: ${sc.orderDateTime}`,
        "",
        ...sc.descriptionLines,
        "",
        "Press START to see the failure."
      ];

      setScreen(lines, [
        { label: "START", onClick: () => showErrorScreen() },
        { label: "Back to Main Menu", onClick: () => showMainMenu() }
      ], "intro");
    }

    // ---------- GENERIC ERROR SCREEN ----------

    function showErrorScreen() {
      const sc = getScenario();
      const lines = [
        "=== ERROR SCREEN ===",
        "",
        `Scenario: ${sc.name}`,
        "",
        `PO:        ${sc.poRef}`,
        `Date/Time: ${sc.orderDateTime}`,
        "",
        "Order Failure:",
        `  ${sc.errorText}`,
        "",
        "Sender:   " + sc.senderName,
        "Supplier: " + sc.supplierName,
        "",
        "What do you want to do?"
      ];

      setScreen(lines, [
        { label: "1) View order details", onClick: () => showOrderDetails() },
        { label: "2) Check boarding sheet", onClick: () => showBoardingSheet() },
        { label: "3) Check further (lists / codelookups)", onClick: () => showCheckFurther() },
        { label: "4) Contact customer", onClick: () => showContactCustomer() },
        { label: "5) Try to process order", onClick: () => showProcessOrder() },
        { label: "Back to Main Menu", onClick: () => showMainMenu() }
      ], "error");
    }

    // ---------- ORDER DETAILS SCREEN ----------

    function formatAddress(label, addr) {
      return [
        label,
        "  Department: " + addr.department,
        "  Street:     " + addr.street,
        "  City:       " + addr.city,
        "  PostCode:   " + addr.postcode,
        "  Country:    " + addr.country
      ];
    }

    function showOrderDetails() {
      const sc = getScenario();
      const lines = [
        "=== ORDER DETAILS ===",
        "",
        `Scenario: ${sc.name}`,
        "",
        `PO:        ${sc.poRef}`,
        `Date/Time: ${sc.orderDateTime}`,
        "",
        ...formatAddress("Buyer address:", sc.buyerAddress),
        "",
        ...formatAddress("ShipTo address:", sc.shipToAddress),
        "",
        ...formatAddress("BillTo address:", sc.billToAddress),
        "",
        "Use these details to recognise the correct entity and match",
        "it against your internal lists."
      ];

      setScreen(lines, [
        { label: "Back to ERROR SCREEN", onClick: () => showErrorScreen() },
        { label: "Go to PROCESS ORDER", onClick: () => showProcessOrder() }
      ], "details");
    }

    // ---------- BOARDING SHEET (SCENARIO-SPECIFIC) ----------

    function showBoardingSheet() {
      const sc = getScenario();

      if (currentScenarioId === 1) {
        // Scenario 1: EID is discoverable via boarding sheet.
        gameState[1].hasEidFromBoarding = true;

        const lines = [
          "=== BOARDING SHEET - POWERGATE PHARMACIES ===",
          "",
          "You navigate to: Shared Drive -> Pharmacies -> Powergate -> Boarding sheet",
          "",
          "A few rows catch your eye:",
          "",
          "  Name:      HealthPlus Pharmacy",
          "  Dept:      Main Stores",
          "  Street:    7 Warehouse Lane",
          "  City:      London",
          "  PostCode:  NW3 5AB",
          "  Country:   UK",
          "  GLN/EAN:   999000111222",
          `  EID:       ${sc.correctEid}`,
          "",
          "You note down the EID to use in your mapping."
        ];

        setScreen(lines, [
          { label: "Go to PROCESS ORDER", onClick: () => showProcessOrder() },
          { label: "Back to ERROR SCREEN", onClick: () => showErrorScreen() }
        ], "boarding");

      } else if (currentScenarioId === 2) {
        const lines = [
          "=== BOARDING SHEET - RIVERSIDE PHARMACY ===",
          "",
          "You open the boarding sheet. It confirms address details and",
          "some internal identifiers.",
          "",
          "However, the failure is specifically about a Supplier-specific",
          "ship-to account for this order.",
          "",
          "Think about where you normally keep those mappings."
        ];

        setScreen(lines, [
          { label: "Back to ERROR SCREEN", onClick: () => showErrorScreen() }
        ], "boarding");

      } else if (currentScenarioId === 3) {
        const lines = [
          "=== BOARDING SHEET - EASTSIDE NHS TRUST ===",
          "",
          "The boarding sheet confirms the order belongs to Eastside NHS",
          "Trust, and that the ShipTo is valid.",
          "",
          "There is still no Supplier-specific account visible here.",
          "",
          "You may need another source of truth for the supplier-side code."
        ];

        setScreen(lines, [
          { label: "Back to ERROR SCREEN", onClick: () => showErrorScreen() }
        ], "boarding");
      }
    }

    // ---------- CHECK FURTHER (CODELOOKUPS / LISTS) ----------

    function showCheckFurther() {
      const sc = getScenario();

      if (currentScenarioId === 1) {
        const lines = [
          "=== CHECK CODELOOKUPS / GLN ===",
          "",
          "You review existing mappings for this buyer:",
          "",
          "  From CustomerSpecificShipTo {1234} To SupplierSpecificShipTo {S99999}",
          "  From CustomerSpecificShipTo {1234} To EANLocation {999000111222}",
          "",
          "No EID mapping exists yet.",
          "",
          "You will need to introduce a correct EID based on trusted data."
        ];

        setScreen(lines, [
          { label: "Back to ERROR SCREEN", onClick: () => showErrorScreen() }
        ], "checkFurther");

      } else if (currentScenarioId === 2) {
        // Scenario 2: SupplierDefined Accounts WITH the mapping
        const gs = gameState[2];
        const lines = [
          "=== SUPPLIERDEFINED ACCOUNTS - PHARMASUPPLY LTD ===",
          "",
          "You open: SharePoint -> SupplierDefined Accounts -> PharmaSupplyLtd.xlsx",
          "",
          "CustomerShipTo | SupplierShipTo",
          "--------------------------------",
          "1234           | PG-SHIP-1234",
          "5678           | PG-SHIP-5678",
          "9012           | PG-SHIP-9012",
          "",
          "One of these rows matches the failing CustomerSpecificShipTo."
        ];

        setScreen(lines, [
          {
            label: "Select the matching row and note SupplierShipTo",
            onClick: () => {
              gs.hasSupplierShipToFromList = true;
              gs.selectedSupplierShipTo = sc.correctSupplierShipTo;
              const msg = [
                "You note the mapping:",
                "",
                "  CustomerShipTo 5678 -> SupplierShipTo " + sc.correctSupplierShipTo,
                "",
                "You can now use this when processing the order."
              ];
              setScreen(msg, [
                { label: "Go to PROCESS ORDER", onClick: () => showProcessOrder() },
                { label: "Back to ERROR SCREEN", onClick: () => showErrorScreen() }
              ], "checkFurther");
            }
          },
          {
            label: "Ignore the list and go back",
            onClick: () => showErrorScreen()
          }
        ], "checkFurther");

      } else if (currentScenarioId === 3) {
        const lines = [
          "=== SUPPLIERDEFINED ACCOUNTS - NHS SUPPLY CHAIN ===",
          "",
          "You open: SharePoint -> SupplierDefined Accounts -> NHS_Supply_Chain.xlsx",
          "",
          "CustomerShipTo | SupplierShipTo",
          "--------------------------------",
          "1111           | NSC-ACC-1111",
          "2222           | NSC-ACC-2222",
          "3333           | NSC-ACC-3333",
          "",
          "There is no entry for CustomerSpecificShipTo {2468}.",
          "",
          "You will need a brand new account from the right contact and",
          "store it here before you rely on it."
        ];

        setScreen(lines, [
          { label: "Contact customer", onClick: () => showContactCustomer() },
          { label: "Back to ERROR SCREEN", onClick: () => showErrorScreen() }
        ], "checkFurther");
      }
    }

    // ---------- CONTACT CUSTOMER (SCENARIO-SPECIFIC) ----------

    function showContactCustomer() {
      const sc = getScenario();

      if (currentScenarioId === 1) {
        const lines = [
          "=== CONTACT CUSTOMER ===",
          "",
          "You consider contacting the customer about the missing EID.",
          "",
          "For this type of identifier, think carefully about whether the",
          "customer is the right source, or whether an internal reference",
          "should be created based on existing internal data first."
        ];

        setScreen(lines, [
          { label: "Back to ERROR SCREEN", onClick: () => showErrorScreen() }
        ], "contact");

      } else if (currentScenarioId === 2) {
        const lines = [
          "=== CONTACT CUSTOMER (WRONG PATH) ===",
          "",
          "You decide to contact the customer for the SupplierSpecificShipTo.",
          "",
          "In this scenario, the mapping already exists in SupplierDefined",
          "Accounts in SharePoint.",
          "",
          "By skipping that list and going straight to the customer,",
          "you've taken the wrong route.",
          ""
        ];

        loseCredit();

        setScreen(lines, [
          { label: "Back to ERROR SCREEN", onClick: () => showErrorScreen() },
          { label: "Back to Main Menu", onClick: () => showMainMenu() }
        ], "contact");

      } else if (currentScenarioId === 3) {
        const gs = gameState[3];

        const preLines = [
          "=== CONTACT CUSTOMER ===",
          "",
          "You look up the correct contact for Eastside NHS Trust",
          "and send a structured email asking for the supplier-side",
          "account for this ship-to.",
          "",
          `  PO:  ${sc.poRef}`,
          `  ShipTo ID: ${sc.correctCustomerShipTo}`,
          "",
          "The customer replies with a specific code.",
          ""
        ];

        setScreen(preLines, [
          {
            label: "Read reply and capture account",
            onClick: () => {
              const reply = prompt(
                'Customer reply:\n\n"Dear team, please use Q34M35 and reprocess order. Thanks"\n\nType the ShipTo ID they provided:'
              );
              if (!reply) {
                loseCredit();
                const lines = [
                  "You failed to capture a usable account from the reply.",
                  "",
                  "No mapping created.",
                  ""
                ];
                setScreen(lines, [
                  { label: "Back to ERROR SCREEN", onClick: () => showErrorScreen() },
                  { label: "Back to Main Menu", onClick: () => showMainMenu() }
                ], "contact");
                return;
              }

              if (reply.trim().toUpperCase() !== sc.correctSupplierShipTo) {
                loseCredit();
                const lines = [
                  "The value you captured does not match the reply.",
                  "",
                  "Correct value was: " + sc.correctSupplierShipTo,
                  "",
                  "You cannot safely map the order with an incorrect account."
                ];
                setScreen(lines, [
                  { label: "Back to ERROR SCREEN", onClick: () => showErrorScreen() },
                  { label: "Back to Main Menu", onClick: () => showMainMenu() }
                ], "contact");
                return;
              }

              gs.hasSupplierShipToFromCustomer = true;
              gs.capturedSupplierShipTo = sc.correctSupplierShipTo;

              const afterLines = [
                "You correctly captured the new SupplierSpecificShipTo:",
                "",
                "  " + sc.correctSupplierShipTo,
                "",
                "Next step: you need to update your internal list before",
                "relying on this account in mappings."
              ];

              setScreen(afterLines, [
                {
                  label: "Add to SupplierDefined Accounts",
                  onClick: () => {
                    gs.savedToSupplierDefined = true;
                    const msg = [
                      "You add the new account to:",
                      "",
                      "  SupplierDefined Accounts - NHS Supply Chain",
                      "",
                      "Now you can safely use it in your mapping."
                    ];
                    setScreen(msg, [
                      { label: "Go to PROCESS ORDER", onClick: () => showProcessOrder() },
                      { label: "Back to ERROR SCREEN", onClick: () => showErrorScreen() }
                    ], "contact");
                  }
                },
                {
                  label: "Skip updating list (risky)",
                  onClick: () => {
                    loseCredit();
                    const warn = [
                      "You decide not to update the internal list.",
                      "",
                      "Even if this order could be fixed once, the setup",
                      "would not be reliable for future traffic.",
                      "",
                      "In this training, that counts as a failed approach."
                    ];
                    setScreen(warn, [
                      { label: "Back to ERROR SCREEN", onClick: () => showErrorScreen() },
                      { label: "Back to Main Menu", onClick: () => showMainMenu() }
                    ], "contact");
                  }
                }
              ], "contact");
            }
          },
          { label: "Back to ERROR SCREEN", onClick: () => showErrorScreen() }
        ], "contact");
      }
    }

    // ---------- PROCESS ORDER (SCENARIO-SPECIFIC) ----------

    function showProcessOrder() {
      const sc = getScenario();

      let lines = [
        "=== PROCESS ORDER ===",
        "",
        `Scenario: ${sc.name}`,
        "",
        `PO:        ${sc.poRef}`,
        `Date/Time: ${sc.orderDateTime}`,
        "",
        `Error: ${sc.errorText}`,
        "",
        "You are about to create the mapping the exchange will use.",
        "",
        "From: " + sc.senderName + "   {edit}",
        "To:   " + sc.supplierName + "   {edit}",
        "",
        "You will be asked for:",
        "  - Type of lookup (Main / ShipTo / BillTo)",
        "  - FROM qualifier and value",
        "  - TO qualifier and value",
        "",
        "Your answers will decide whether the order passes or fails."
      ];

      setScreen(lines, [
        { label: "Enter mapping and process", onClick: () => enterMappingForScenario() },
        { label: "Back to ERROR SCREEN", onClick: () => showErrorScreen() }
      ], "process");
    }

    function enterMappingForScenario() {
      const sc = getScenario();

      // Scenario-specific “path” preconditions
      if (currentScenarioId === 1) {
        if (!gameState[1].hasEidFromBoarding) {
          loseCredit();
          const lines = [
            "You try to create a mapping without having a clear EID",
            "from your internal references.",
            "",
            "In this training, you are expected to confirm the EID",
            "before using it.",
            ""
          ];
          setScreen(lines, [
            { label: "Back to ERROR SCREEN", onClick: () => showErrorScreen() },
            { label: "Back to Main Menu", onClick: () => showMainMenu() }
          ], "process");
          return;
        }
      } else if (currentScenarioId === 2) {
        if (!gameState[2].hasSupplierShipToFromList) {
          loseCredit();
          const lines = [
            "You attempt to create a mapping without using the",
            "SupplierDefined Accounts list.",
            "",
            "In this scenario, that list is the agreed source.",
            ""
          ];
          setScreen(lines, [
            { label: "Back to ERROR SCREEN", onClick: () => showErrorScreen() },
            { label: "Back to Main Menu", onClick: () => showMainMenu() }
          ], "process");
          return;
        }
      } else if (currentScenarioId === 3) {
        const gs = gameState[3];
        if (!(gs.hasSupplierShipToFromCustomer && gs.savedToSupplierDefined)) {
          loseCredit();
          const lines = [
            "You try to map the order without both:",
            "",
            "  - capturing the new account from the customer, and",
            "  - updating SupplierDefined Accounts.",
            "",
            "For this scenario, you must do BOTH before using the code."
          ];
          setScreen(lines, [
            { label: "Back to ERROR SCREEN", onClick: () => showErrorScreen() },
            { label: "Back to Main Menu", onClick: () => showMainMenu() }
          ], "process");
          return;
        }
      }

      // Now collect mapping details
      const fromName = prompt("Enter FROM organisation name (buyer):");
      if (!fromName) { mappingFailed("Mapping incomplete (missing From name)."); return; }

      const toName = prompt("Enter TO organisation name (supplier):");
      if (!toName) { mappingFailed("Mapping incomplete (missing To name)."); return; }

      const lookupTypeInput = prompt("Type of lookup (Main / ShipTo / BillTo):");
      if (!lookupTypeInput) { mappingFailed("Mapping incomplete (missing lookup type)."); return; }
      const lookupType = lookupTypeInput.trim().toLowerCase();

      const fromQNum = prompt(
        "FROM side qualifier:\n" +
        " 1) From EID\n" +
        " 2) From EanLocation\n" +
        " 3) From CustomerSpecificShipTo\n" +
        " 4) From CustomerSpecificBillTo\n" +
        " 5) From SupplierSpecificShipTo\n" +
        " 6) From SupplierSpecificBillTo\n\n" +
        "Enter 1-6:"
      );
      const fromQualifier = mapQualifier(true, fromQNum);
      if (!fromQualifier) { mappingFailed("Invalid FROM qualifier choice."); return; }

      const fromValue = prompt("Enter FROM value:");
      if (!fromValue) { mappingFailed("Mapping incomplete (missing FROM value)."); return; }

      const toQNum = prompt(
        "TO side qualifier:\n" +
        " 1) To EID\n" +
        " 2) To EanLocation\n" +
        " 3) To CustomerSpecificShipTo\n" +
        " 4) To CustomerSpecificBillTo\n" +
        " 5) To SupplierSpecificShipTo\n" +
        " 6) To SupplierSpecificBillTo\n\n" +
        "Enter 1-6:"
      );
      const toQualifier = mapQualifier(false, toQNum);
      if (!toQualifier) { mappingFailed("Invalid TO qualifier choice."); return; }

      const toValue = prompt("Enter TO value:");
      if (!toValue) { mappingFailed("Mapping incomplete (missing TO value)."); return; }

      // Validation
      const namesOk =
        fromName.trim().toLowerCase() === sc.senderName.toLowerCase() &&
        toName.trim().toLowerCase() === sc.supplierName.toLowerCase();

      let lookupTypeOk = false;
      let fromOk = false;
      let toOk = false;

      if (currentScenarioId === 1) {
        // ShipTo -> EID
        lookupTypeOk = (lookupType === "shipto");
        fromOk =
          fromQualifier.toLowerCase() === "from customerspecificshipto" &&
          fromValue.trim() === "1234";
        toOk =
          toQualifier.toLowerCase() === "to eid" &&
          toValue.trim() === scenarios[1].correctEid;
      } else if (currentScenarioId === 2) {
        // ShipTo -> SupplierSpecificShipTo
        lookupTypeOk = (lookupType === "shipto");
        fromOk =
          fromQualifier.toLowerCase() === "from customerspecificshipto" &&
          fromValue.trim() === scenarios[2].correctCustomerShipTo;
        const gs2 = gameState[2];
        const expectedSupp = gs2.selectedSupplierShipTo || scenarios[2].correctSupplierShipTo;
        toOk =
          toQualifier.toLowerCase() === "to supplierspecificshipto" &&
          toValue.trim().toUpperCase() === expectedSupp.toUpperCase();
      } else if (currentScenarioId === 3) {
        // ShipTo -> SupplierSpecificShipTo with new account Q34M35
        lookupTypeOk = (lookupType === "shipto");
        fromOk =
          fromQualifier.toLowerCase() === "from customerspecificshipto" &&
          fromValue.trim() === scenarios[3].correctCustomerShipTo;
        toOk =
          toQualifier.toLowerCase() === "to supplierspecificshipto" &&
          toValue.trim().toUpperCase() === scenarios[3].correctSupplierShipTo;
      }

      if (namesOk && lookupTypeOk && fromOk && toOk) {
        showSuccess();
      } else {
        mappingFailed("The mapping you entered is not correct for this failure.");
      }
    }

    function mapQualifier(isFrom, choiceStr) {
      const n = parseInt(choiceStr, 10);
      if (isNaN(n)) return null;
      if (isFrom) {
        switch (n) {
          case 1: return "From EID";
          case 2: return "From EanLocation";
          case 3: return "From CustomerSpecificShipTo";
          case 4: return "From CustomerSpecificBillTo";
          case 5: return "From SupplierSpecificShipTo";
          case 6: return "From SupplierSpecificBillTo";
          default: return null;
        }
      } else {
        switch (n) {
          case 1: return "To EID";
          case 2: return "To EanLocation";
          case 3: return "To CustomerSpecificShipTo";
          case 4: return "To CustomerSpecificBillTo";
          case 5: return "To SupplierSpecificShipTo";
          case 6: return "To SupplierSpecificBillTo";
          default: return null;
        }
      }
    }

    function mappingFailed(reason) {
      loseCredit();
      const sc = getScenario();
      const lines = [
        "=== ORDER STILL FAILING ===",
        "",
        `Scenario: ${sc.name}`,
        "",
        reason,
        "",
        "Review the failure, think about the correct source for data,",
        "and try again while you still have time and credits."
      ];
      setScreen(lines, [
        { label: "Back to ERROR SCREEN", onClick: () => showErrorScreen() },
        { label: "Back to Main Menu", onClick: () => showMainMenu() }
      ], "process");
    }

    // ---------- SUCCESS / TIMEUP / GAMEOVER ----------

    function showSuccess() {
      if (timerId) {
        clearInterval(timerId);
        timerId = null;
      }
      const sc = getScenario();

      const lines = [
        "=== ORDER SUCCESSFULLY PROCESSED ===",
        "",
        `Scenario: ${sc.name}`,
        "",
        "You followed a valid path and built the correct mapping.",
        "",
        "The order clears, and the failure is resolved.",
        "",
        "Bonus: play a quick SPACE CLEANUP mini-game?"
      ];

      setScreen(lines, [
        { label: "Play SPACE CLEANUP", onClick: () => startMiniGame() },
        { label: "Back to Main Menu", onClick: () => showMainMenu() }
      ], null);
    }

    function showTimeUp() {
      const sc = getScenario();
      const lines = [
        "=== TIME UP ===",
        "",
        `Scenario: ${sc.name}`,
        "",
        "You ran out of time before fixing the order.",
        "",
        "The order remains in failure.",
        ""
      ];

      setScreen(lines, [
        { label: "Back to ERROR SCREEN", onClick: () => showErrorScreen() },
        { label: "Back to Main Menu", onClick: () => showMainMenu() }
      ], "error");
    }

    function showGameOver() {
      const lines = [
        "=== GAME OVER ===",
        "",
        "You have no credits left for this run.",
        "",
        "In a real shift, this would be multiple orders still failing.",
        "",
        "Here, you can just try again and refine your decisions.",
        ""
      ];

      setScreen(lines, [
        { label: "Back to Main Menu", onClick: () => showMainMenu() }
      ], null);
    }

    // ---------- BONUS MINI-GAME: SPACE CLEANUP ----------

    function startMiniGame() {
      miniGameActive = true;
      if (timerId) {
        clearInterval(timerId);
        timerId = null;
      }
      timerEl.textContent = "BONUS: SPACE CLEANUP  |  ←/→ move, SPACE = fire, Q = quit";

      const width = 20;
      const height = 12;

      // create simple enemy formation
      const enemies = [];
      for (let y = 1; y <= 3; y++) {
        for (let x = 3; x < width - 3; x += 2) {
          enemies.push({ x, y });
        }
      }

      miniGameState = {
        width,
        height,
        playerX: Math.floor(width / 2),
        enemies,
        bullets: [],
        tick: 0,
        gameOver: false,
        win: false
      };

      drawMiniGame();
      if (miniGameLoopId) clearInterval(miniGameLoopId);
      miniGameLoopId = setInterval(updateMiniGame, 120);
    }

    function stopMiniGame() {
      miniGameActive = false;
      if (miniGameLoopId) {
        clearInterval(miniGameLoopId);
        miniGameLoopId = null;
      }
      updateStatusBar();
    }

    function updateMiniGame() {
      if (!miniGameActive || !miniGameState || miniGameState.gameOver) return;

      const s = miniGameState;
      s.tick++;

      // move bullets up
      s.bullets.forEach(b => b.y--);
      s.bullets = s.bullets.filter(b => b.y >= 0);

      // enemy movement (down every few ticks)
      if (s.tick % 8 === 0) {
        s.enemies.forEach(e => e.y++);
      }

      // collisions: bullets vs enemies
      for (let i = s.bullets.length - 1; i >= 0; i--) {
        const b = s.bullets[i];
        for (let j = s.enemies.length - 1; j >= 0; j--) {
          const e = s.enemies[j];
          if (b.x === e.x && b.y === e.y) {
            s.enemies.splice(j, 1);
            s.bullets.splice(i, 1);
            break;
          }
        }
      }

      // check lose: any enemy reaches player row
      if (s.enemies.some(e => e.y >= s.height - 1)) {
        s.gameOver = true;
        s.win = false;
        stopMiniGame();
        showMiniGameResult(false);
        return;
      }

      // check win: all enemies destroyed
      if (s.enemies.length === 0) {
        s.gameOver = true;
        s.win = true;
        stopMiniGame();
        showMiniGameResult(true);
        return;
      }

      drawMiniGame();
    }

    function drawMiniGame() {
      const s = miniGameState;
      if (!s) return;

      const grid = [];
      for (let y = 0; y < s.height; y++) {
        let row = "";
        for (let x = 0; x < s.width; x++) {
          row += " ";
        }
        grid.push(row.split(""));
      }

      // enemies
      s.enemies.forEach(e => {
        if (e.y >= 0 && e.y < s.height && e.x >= 0 && e.x < s.width) {
          grid[e.y][e.x] = "^";
        }
      });

      // bullets
      s.bullets.forEach(b => {
        if (b.y >= 0 && b.y < s.height && b.x >= 0 && b.x < s.width) {
          grid[b.y][b.x] = "|";
        }
      });

      // player
      const py = s.height - 1;
      if (s.playerX >= 0 && s.playerX < s.width) {
        grid[py][s.playerX] = "A";
      }

      const lines = [
        "=== BONUS GAME: SPACE CLEANUP ===",
        "",
        "Clear the incoming errors (^) before they reach you (A).",
        "",
        grid.map(row => row.join("")).join("\n"),
        "",
        "Controls: ←/→ or A/D to move, SPACE to fire, Q to quit",
        ""
      ];

      screenEl.textContent = lines.join("\n");
      optionsEl.textContent = ""; // no buttons, keyboard only
    }

    function showMiniGameResult(win) {
      const lines = win
        ? [
            "=== SPACE CLEANUP - VICTORY ===",
            "",
            "You cleared all the incoming errors.",
            "",
            "Well done!",
            ""
          ]
        : [
            "=== SPACE CLEANUP - FAILED ===",
            "",
            "An error wave reached your position.",
            "",
            "The galaxy of mappings trembles...",
            ""
          ];

      setScreen(lines, [
        { label: "Back to Main Menu", onClick: () => showMainMenu() }
      ], null);
    }

    // Keyboard controls for mini-game
    document.addEventListener("keydown", (ev) => {
      if (!miniGameActive || !miniGameState) return;

      const s = miniGameState;
      const key = ev.key;

      if (key === "ArrowLeft" || key === "a" || key === "A") {
        s.playerX = Math.max(0, s.playerX - 1);
        drawMiniGame();
      } else if (key === "ArrowRight" || key === "d" || key === "D") {
        s.playerX = Math.min(s.width - 1, s.playerX + 1);
        drawMiniGame();
      } else if (key === " " || key === "Spacebar") {
        // fire bullet from just above player
        s.bullets.push({ x: s.playerX, y: s.height - 2 });
        drawMiniGame();
      } else if (key === "q" || key === "Q") {
        stopMiniGame();
        showMainMenu();
      }
    });

    // ---------- START ----------

    showMainMenu();
  </script>
</body>
</html>
